<!DOCTYPE html>
<html lang="en"><head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FWJK9XZLFC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FWJK9XZLFC');
</script>
  
<!-- Google tag (gtag.js) -->

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Motion Capture | otávio mk</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Motion Capture" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="otávio manzano kavakama - cello" />
<meta property="og:description" content="otávio manzano kavakama - cello" />
<link rel="canonical" href="https://otaviomk.com/mocap/" />
<meta property="og:url" content="https://otaviomk.com/mocap/" />
<meta property="og:site_name" content="otávio mk" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Motion Capture" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"otávio manzano kavakama - cello","headline":"Motion Capture","url":"https://otaviomk.com/mocap/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
  <link rel="shortcut icon" type="image/png" href="/favicon.png"/><link type="application/atom+xml" rel="alternate" href="https://otaviomk.com/feed.xml" title="otávio mk" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a style="color:#fca311" class="site-title" rel="author" href="/">otávio mk</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">about</a><a class="page-link" href="/media/">media</a><a class="page-link" href="/works/">works</a><a class="page-link" href="/contact/">contact</a><a class='page-link page-link-flag' href="">
                    <img src="/assets/flag_br.jpg" style="height: 20px; border-radius: 50%;"></a>
        </div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Motion Capture</h1>
  </header>

  <div class="post-content">
    <p>Motion Capture using Pure Data, MediaPipe, Ardour</p>

<h1 id="mediapipe-python-script">MediaPipe Python Script</h1>

<p>Install:</p>

<p><code class="language-plaintext highlighter-rouge">pip install mediapipe opencv-python python-osc numpy</code></p>

<p>Create python script:</p>

<p><code class="language-plaintext highlighter-rouge">mediapipe_to_pd.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">cv2</span>
<span class="kn">import</span> <span class="n">mediapipe</span> <span class="k">as</span> <span class="n">mp</span>
<span class="kn">from</span> <span class="n">pythonosc</span> <span class="kn">import</span> <span class="n">udp_client</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="c1"># OSC setup
</span><span class="n">OSC_IP</span> <span class="o">=</span> <span class="sh">"</span><span class="s">127.0.0.1</span><span class="sh">"</span>
<span class="n">OSC_PORT</span> <span class="o">=</span> <span class="mi">8000</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">udp_client</span><span class="p">.</span><span class="nc">SimpleUDPClient</span><span class="p">(</span><span class="n">OSC_IP</span><span class="p">,</span> <span class="n">OSC_PORT</span><span class="p">)</span>

<span class="n">mp_pose</span> <span class="o">=</span> <span class="n">mp</span><span class="p">.</span><span class="n">solutions</span><span class="p">.</span><span class="n">pose</span>
<span class="n">pose</span> <span class="o">=</span> <span class="n">mp_pose</span><span class="p">.</span><span class="nc">Pose</span><span class="p">(</span>
    <span class="n">min_detection_confidence</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">min_tracking_confidence</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nc">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fps_limit</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">last_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

<span class="k">while</span> <span class="n">cap</span><span class="p">.</span><span class="nf">isOpened</span><span class="p">():</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="p">.</span><span class="nf">read</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">frame_rgb</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="nf">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pose</span><span class="p">.</span><span class="nf">process</span><span class="p">(</span><span class="n">frame_rgb</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">results</span><span class="p">.</span><span class="n">pose_landmarks</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">lm</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="n">pose_landmarks</span><span class="p">.</span><span class="n">landmark</span><span class="p">):</span>
            <span class="c1"># normalized coordinates (0–1)
</span>            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">lm</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">lm</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">lm</span><span class="p">.</span><span class="n">z</span>

            <span class="n">client</span><span class="p">.</span><span class="nf">send_message</span><span class="p">(</span><span class="sh">"</span><span class="s">/pose</span><span class="sh">"</span><span class="p">,</span> <span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>

    <span class="c1"># FPS limit
</span>    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_time</span>
    <span class="n">sleep_time</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">fps_limit</span><span class="p">)</span> <span class="o">-</span> <span class="n">elapsed</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
    <span class="n">last_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>

<span class="n">cap</span><span class="p">.</span><span class="nf">release</span><span class="p">()</span>

</code></pre></div></div>

<p>To run: <code class="language-plaintext highlighter-rouge">python mediapipe_to_pd.py</code></p>

<hr />

<h1 id="pure-data-patch">Pure Data Patch</h1>

<p><img src="/assets/MOCAP_pd_1.png" alt="pfp2" /></p>

<p>subpatches for each element, <code class="language-plaintext highlighter-rouge">[pd MOCAP_nose]</code> for example:</p>

<p><img src="/assets/MOCAP_pd_2.png" alt="pfp" /></p>

<p>There’s a lot of fine tuning here. <code class="language-plaintext highlighter-rouge">[scale]</code> is your friend. For MIDI, we need the output to be 0 - 127. So first you need to find your raw output numbers, use scale to have it between 0 - 127.</p>

<p>The message <code class="language-plaintext highlighter-rouge">[$1 100(</code> connected to <code class="language-plaintext highlighter-rouge">line</code> is basically to smooth the signal so it’s not super truncated. <code class="language-plaintext highlighter-rouge">$1</code> is the raw signal, <code class="language-plaintext highlighter-rouge">100</code> is the milliseconds to which <code class="language-plaintext highlighter-rouge">line</code> will take to go from one input to the other.</p>

<p>There are 33 elements that are being captured, as we can see here:</p>

<p><img src="/assets/pose_tracking_full_body_landmarks.png" alt="image" /></p>

<p>Image from here: <a href="https://chuoling.github.io/mediapipe/solutions/pose.html">https://chuoling.github.io/mediapipe/solutions/pose.html</a></p>

<hr />

<h1 id="ardour">Ardour</h1>

<h2 id="midi-map">Midi Map</h2>

<p>Create new midi map for the pure data midi output.</p>

<p>The midi map goes in <code class="language-plaintext highlighter-rouge">/usr/share/ardour8/midi_maps</code></p>

<p><code class="language-plaintext highlighter-rouge">MOCAP.map</code></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;ArdourMIDIBindings</span> <span class="na">version=</span><span class="s">"1.0.0"</span> <span class="na">name=</span><span class="s">"MOCAP"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Binding</span> <span class="na">channel=</span><span class="s">"1"</span> <span class="na">ctl=</span><span class="s">"1"</span> <span class="na">uri=</span><span class="s">"/route/gain 1"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;Binding</span> <span class="na">channel=</span><span class="s">"1"</span> <span class="na">ctl=</span><span class="s">"2"</span> <span class="na">uri=</span><span class="s">"/route/gain 2"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;Binding</span> <span class="na">channel=</span><span class="s">"1"</span> <span class="na">ctl=</span><span class="s">"3"</span> <span class="na">uri=</span><span class="s">"/route/gain 3"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;Binding</span> <span class="na">channel=</span><span class="s">"1"</span> <span class="na">ctl=</span><span class="s">"4"</span> <span class="na">uri=</span><span class="s">"/route/gain 4"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;Binding</span> <span class="na">channel=</span><span class="s">"1"</span> <span class="na">ctl=</span><span class="s">"5"</span> <span class="na">uri=</span><span class="s">"/route/gain 5"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;Binding</span> <span class="na">channel=</span><span class="s">"1"</span> <span class="na">ctl=</span><span class="s">"6"</span> <span class="na">uri=</span><span class="s">"/route/gain 6"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/ArdourMIDIBindings&gt;</span>
</code></pre></div></div>

<h2 id="to-use-it-in-ardour">To use it in Ardour</h2>

<ul>
  <li>Edit -&gt; Preferences -&gt; Control Surfaces</li>
  <li>Select <code class="language-plaintext highlighter-rouge">Generic MIDI</code> and click <code class="language-plaintext highlighter-rouge">Show Protocol Settings</code>
    <ul>
      <li>Incoming MIDI on: MIDI Through Port-0 (capture)</li>
      <li>MIDI Bindings: MOCAP</li>
    </ul>
  </li>
  <li>Exit both windows and it should be good to go.</li>
</ul>

<h2 id="check-if-youre-getting-signal">Check if you’re getting signal</h2>

<ul>
  <li>Go to Window -&gt; MIDI Tracer</li>
  <li>Port: MIDI Through Port-0</li>
</ul>

<p>You should see cascading numbers and see that you have the channel and controls giving the values you’re expecting:</p>

<p><img src="/assets/MOCAP_ardour_midi_tracer.png" alt="tracer" /></p>

<hr />

<h1 id="how-it-works">How it works</h1>

<p>In pure data, the object [ctlout] is the one sending the MIDI signals. You need to specify the channel and controller. I have it as channel 1, so it looks like in the picture above: [ctlout 1 1], [ctlout 2 1], [ctlout 3 1], etc.</p>

<p>It is a bit confusing because in Pure Data the order is Channel then Controller. But in Ardour it is Controller then Channel. I think…</p>

<p>The number of channels you have in your pure data patch should minimally match the midi map for Ardour. The configuration for the midi map should be straightforward. Check other midi maps for inspiration.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <!-- <h2 class="footer-heading">otávio mk</h2> -->

    <!-- <div class="footer-col-wrapper"> -->
      <!-- <div class="footer-col footer-col-1"> -->
      <!--   <ul class="contact-list"> -->
      <!--     <!-1- <li class="p-name"> -1-> -->
      <!--     <!-1--1-> -->
      <!--     <!-1-     otávio mk -1-> -->
      <!--     <!-1--1-> -->
      <!--     <!-1-   </li> -1-> -->
      <!--       <!-1--1-> -->
      <!--   </ul> -->
      <!-- </div> -->

      <!-- <div class="footer-col footer-col-2"> -->
      <div><ul class="social-media-list">
  <!-- <li style="display:inline"><a target="_blank" href="https://www.youtube.com/channel/UCFSm9mZHqqNlxPxyEDmPjQA"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username"></span></a></li> --><li style="display:inline"><a target="_blank" href="https://www.youtube.com/@otaviomanzanokavakama">youtube</a></li>
<li style="display:inline"><a target="_blank" href="https://kavotaman.bandcamp.com">bandcamp</a></li>
<li style="display:inline"><a target="_blank" href="https://ruidospodcast.com.br">ruidospodcast</a></li>
<li style="display:inline"><a target="_blank" href="https://github.com/kavotaman">github</a></li>
</ul>
</div>

      <!-- <div class="footer-col footer-col-3"> -->
      <!--   <p>otávio manzano kavakama - cello</p> -->
      <!-- </div> -->
    <!-- </div> -->

  </div>

</footer>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const toc = document.querySelector(".toc");
  const tocList = document.querySelector("#js-toc");
  const toggle = document.querySelector(".toc-toggle");
  const content = document.querySelector(".post-content");

  // Build TOC from headings
  if (tocList && content) {
    const headings = content.querySelectorAll("h1, h2, h3");
    headings.forEach(h => {
      if (!h.id) {
        h.id = h.textContent.trim().toLowerCase().replace(/\s+/g, "-");
      }
      const li = document.createElement("li");
      li.style.marginLeft = h.tagName === "H3" ? "1rem" : "0"; // indent h3
      const a = document.createElement("a");
      a.href = "#" + h.id;
      a.textContent = h.textContent;
      li.appendChild(a);
      tocList.appendChild(li);
    });
  }

  // Mobile toggle
  if (toggle) {
    toggle.addEventListener("click", () => {
      toc.classList.toggle("open");
    });
  }
});
</script>

  </body>

</html>
