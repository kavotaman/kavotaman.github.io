<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chord Transposer</title>
<link rel="icon" type="image/x-icon" href="/chords/favicon.png">

<style>
  :root{
    --accent:#5CB9FF;
    --bg:#2e2e2e;
    --text:#eaeaea;
  }

  /* page */
  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    max-width:900px;
    margin:2rem auto;
    padding:1rem;
    background:var(--bg);
    color:var(--text);
  }

  h1{ color:var(--accent); text-align:center; font-size:clamp(1.5rem,4vw,2.2rem); margin-bottom:0.5rem; }
  p{ color:var(--accent); text-align:center; margin-top:0; margin-bottom:1rem; }

  input[type="text"]{ width:96%; padding:0.5rem; margin:0 auto 1rem auto; display:block; font-size:1.1rem;
    border-radius:6px; border:1px solid #444; background:#1e1e1e; color:#e0e0e0; box-sizing:border-box;}
  textarea{ width:94%; min-height:220px; padding:0.75rem; margin:0 auto 1rem auto; display:block;
    border-radius:8px; border:1px solid #444; background:#1e1e1e; color:#e0e0e0; font-family:monospace; resize:vertical; box-sizing:border-box; }

  .controls{ display:flex; flex-wrap:wrap; gap:0.5rem; justify-content:center; margin-bottom:1rem; }
  .controls button{ flex:1 1 100px; background:#4da3ff; color:#fff; border:none; border-radius:8px; padding:0.6rem 1rem; cursor:pointer; }
  .controls button:hover{ background:#1e90ff; }

  details{ margin-bottom:1rem; background:#1e1e1e; padding:1rem; border-radius:8px; }
  details summary{ cursor:pointer; color:var(--accent); font-weight:700; }

  #previewContainer{ display:flex; justify-content:center; align-items:center; }

  /* large printable output area (like original) */
  #output{
    background:#fff;
    color:#000;
    box-shadow:0 0 10px rgba(0,0,0,0.3);
    border-radius:4px;
    transition:all .2s ease;
    aspect-ratio:8.5/11;
    width:100%;
    max-width:816px; /* 8.5in * 96dpi */
    overflow-y:auto;
    border:1px solid #ccc;
    white-space:pre-wrap;
    line-height:1.6;
    box-sizing:border-box;
    /* default font will be overridden when we register fonts */
    font-family: "SabonNext", serif;
    color:#000;
  }

  /* chord font for the highlighted tokens */
  #output strong{
    font-family: "KozukaGothic", sans-serif;
    font-weight:400;
    font-size:10px;
    color:#004685;
    border-radius:4px;
    padding:0 2px;
  }

  @media (max-width:600px){
    body{ padding:0.5rem; }
    textarea{ height:180px; font-size:0.95rem; }
    .controls{ justify-content:space-between; }
    .controls button{ flex:1 1 45%; padding:0.5rem; font-size:0.9rem; }
  }
</style>
</head>
<body>
  <h1>Chord Transposer</h1>
  <p>Paste your lyrics and chords below, then click to transpose or change notation.</p>

  <input id="songTitle" type="text" placeholder="Song title..." oninput="updateOutput()" />
  <textarea id="input" placeholder="Paste your song here..."></textarea>

  <div class="controls">
    <button onclick="transposeDown()">-</button>
    <button onclick="transposeUp()">+</button>
    <button id="toggleFlats" onclick="toggleFlats()">Show ♭</button>
    <button onclick="exportTXT()">Save .TXT</button>
    <button onclick="exportPDF()">Save PDF</button>
    <button><a href="/chords/ocr.html" target="_blank" style="color:inherit; text-decoration:none; display:block;">OCR Tool</a></button>
  </div>

  <details>
    <summary>Settings</summary>
    <div style="margin-top:0.5rem;">
      <label>Title Font Size:
        <input type="number" id="titleFontSize" value="14" min="8" max="36" style="width:60px">
      </label><br/>
      <label>Body Font Size:
        <input type="number" id="bodyFontSize" value="10" min="6" max="24" style="width:60px">
      </label><br/>
      <label>PDF Margin (pt):
        <input type="number" id="pdfMargin" value="40" min="10" max="100" style="width:60px">
      </label><br/>
      <label>Chord Detection Threshold:
        <input type="range" id="chordThreshold" min="0" max="1" step="0.05" value="0.4" oninput="document.getElementById('thresholdVal').textContent=this.value">
        <span id="thresholdVal">0.4</span>
      </label>
    </div>
  </details>

  <div id="previewContainer">
    <div id="output"></div>
  </div>

<!-- ====== App Script ====== -->
<script>
/* ----- constants/state ----- */
const NOTES_SHARP = ["C","C♯","D","D♯","E","F","F♯","G","G♯","A","A♯","B"];
const NOTES_FLAT  = ["C","D♭","D","E♭","E","F","G♭","G","A♭","A","B♭","B"];
let useFlatsDisplay = false;
let currentTranspose = 0;
let chordThreshold = 0.4;

const CHORD_REGEX = /\b([A-G](?:♯|♭)?)([^\s]*)/g;

/* ----- font helpers ----- */
async function loadArrayBufferAsBase64(path) {
  const res = await fetch(path);
  if (!res.ok) throw new Error("Font not found: " + path);
  const buf = await res.arrayBuffer();
  // convert to base64
  let binary = "";
  const bytes = new Uint8Array(buf);
  const chunk = 0x8000;
  for (let i = 0; i < bytes.length; i += chunk) {
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
  }
  return btoa(binary);
}

async function registerFontsForBrowser() {
  if (document.getElementById("font-injected")) return;
  try {
    const [kozukaB64, sabonB64] = await Promise.all([
      loadArrayBufferAsBase64("Kozuka Gothic Pr6N R.otf"),
      loadArrayBufferAsBase64("SabonNext LT-Regular.otf")
    ]);
    const css = `
      @font-face{ font-family:"KozukaGothic"; src: url(data:font/otf;base64,${kozukaB64}) format("opentype"); font-weight:400; font-style:normal; }
      @font-face{ font-family:"SabonNext"; src: url(data:font/otf;base64,${sabonB64}) format("opentype"); font-weight:400; font-style:normal; }
    `;
    const s = document.createElement("style");
    s.id = "font-injected";
    s.appendChild(document.createTextNode(css));
    document.head.appendChild(s);
    // ensure fonts loaded
    await Promise.all([
      document.fonts.load('12pt "KozukaGothic"'),
      document.fonts.load('12pt "SabonNext"')
    ]);
  } catch (err) {
    console.warn("Could not load fonts for preview:", err);
  }
}

/* ----- transpose/highlight logic (same as before) ----- */
function transposeNote(note, steps) {
  const idxSharp = NOTES_SHARP.indexOf(note);
  const idxFlat  = NOTES_FLAT.indexOf(note);
  const idx = idxSharp !== -1 ? idxSharp : idxFlat;
  if (idx === -1) return note;
  const newSharp = NOTES_SHARP[(idx + steps + 12) % 12];
  const newFlat  = NOTES_FLAT[(idx + steps + 12) % 12];
  return useFlatsDisplay ? newFlat : newSharp;
}

function transposeChord(chord, steps) {
  return chord.replace(/^([A-G](?:♯|♭)?)(.*)$/, (_, root, rest) => {
    const newRoot = transposeNote(root, steps);
    // slash bass
    const slashMatch = rest.match(/\/([A-G](?:♯|♭)?)(?!\d)/);
    if (slashMatch) {
      const bass = slashMatch[1];
      const transposedBass = transposeNote(bass, steps);
      rest = rest.replace("/" + bass, "/" + transposedBass);
    }
    return newRoot + rest;
  });
}

function transposeText(text, steps) {
  return text.replace(CHORD_REGEX, chord => transposeChord(chord, steps));
}

function highlightChords(text) {
  return text.replace(CHORD_REGEX, match => `<strong>${match}</strong>`);
}

/* ----- UI update ----- */
const DPI = 96;
const PT_TO_PX = DPI / 72;
function ptToPx(pt){ return pt * PT_TO_PX; }

async function updateOutput(){
  await registerFontsForBrowser();
  const title = document.getElementById("songTitle").value.trim();
  const input = document.getElementById("input").value || "";
  const lines = input.split(/\n/);

  const out = lines.map(line=>{
    const tokens = line.trim().split(/\s+/);
    if (!tokens.length) return line;
    const chordCount = tokens.filter(w => /^[A-G](?:♯|♭)?/.test(w)).length;
    if (chordCount / tokens.length >= chordThreshold) {
      return highlightChords(transposeText(line, currentTranspose));
    }
    return line;
  }).join("\n");

  const titleFontSizePt = parseFloat(document.getElementById("titleFontSize").value || 14);
  const bodyFontSizePt  = parseFloat(document.getElementById("bodyFontSize").value || 10);
  const marginPt = parseFloat(document.getElementById("pdfMargin").value || 40);
  const titleFontSizePx = ptToPx(titleFontSizePt);
  const bodyFontSizePx = ptToPx(bodyFontSizePt);
  const marginPx = ptToPx(marginPt);
  const printableWidthPx = 8.5 * DPI - marginPx * 2;

  const titleHTML = title ? `<div style="text-align:center;color:#5CB9FF;margin-top:0;font-size:${titleFontSizePx}px;font-weight:700">${escapeHtml(title)}</div>\n` : "";

  const outputDiv = document.getElementById("output");
  outputDiv.innerHTML = titleHTML + out;
  outputDiv.style.fontSize = bodyFontSizePx + "px";
  outputDiv.style.width = printableWidthPx + "px";
  outputDiv.style.padding = marginPx + "px";
}

/* escape helper for safety */
function escapeHtml(s){
  return s.replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]);
}

/* ----- controls ----- */
function transposeUp(){ currentTranspose++; updateOutput(); }
function transposeDown(){ currentTranspose--; updateOutput(); }
function toggleFlats(){
  useFlatsDisplay = !useFlatsDisplay;
  document.getElementById("toggleFlats").textContent = useFlatsDisplay ? "Show ♯" : "Show ♭";
  updateOutput();
}

/* ----- settings persistence ----- */
function loadSettings(){
  const s = JSON.parse(localStorage.getItem("transposerSettings") || "{}");
  if (s.titleFontSize) document.getElementById("titleFontSize").value = s.titleFontSize;
  if (s.bodyFontSize) document.getElementById("bodyFontSize").value = s.bodyFontSize;
  if (s.pdfMargin) document.getElementById("pdfMargin").value = s.pdfMargin;
  if (s.chordThreshold !== undefined){
    document.getElementById("chordThreshold").value = s.chordThreshold;
    document.getElementById("thresholdVal").textContent = s.chordThreshold;
    chordThreshold = parseFloat(s.chordThreshold);
  }
}
function saveSettings(){
  const settings = {
    titleFontSize: document.getElementById("titleFontSize").value,
    bodyFontSize: document.getElementById("bodyFontSize").value,
    pdfMargin: document.getElementById("pdfMargin").value,
    chordThreshold: document.getElementById("chordThreshold").value
  };
  localStorage.setItem("transposerSettings", JSON.stringify(settings));
}

/* wire up inputs */
document.querySelectorAll("#titleFontSize,#bodyFontSize,#pdfMargin").forEach(el=>{
  el.addEventListener("input", ()=>{ saveSettings(); updateOutput(); });
});
document.getElementById("chordThreshold").addEventListener("input", e=>{
  chordThreshold = parseFloat(e.target.value);
  document.getElementById("thresholdVal").textContent = e.target.value;
  saveSettings(); updateOutput();
});
document.getElementById("input").addEventListener("input", updateOutput);

/* init */
loadSettings();
registerFontsForBrowser().then(updateOutput).catch(()=>updateOutput());

/* ----- TXT export ----- */
function exportTXT(){
  const title = document.getElementById("songTitle").value.trim();
  const text = (title ? title + "\n\n" : "") + document.getElementById("output").innerText;
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "transposed_chords.txt";
  link.click();
}

/* ----- PDF export (fixed + fonts embedded + wrapping) ----- */
</script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
async function exportPDF() {
  const { jsPDF } = window.jspdf;

  // Make sure fonts have loaded
  await document.fonts.ready;

  const pdf = new jsPDF({ orientation: "portrait", unit: "pt", format: "letter" });
  const margin = parseFloat(document.getElementById("pdfMargin").value || 40);
  const pageWidth = 8.5 * 72;
  const pageHeight = 11 * 72;
  const printableWidth = pageWidth - margin * 2;

  // Capture the output div exactly as shown
  const outputDiv = document.getElementById("output");
  const canvas = await html2canvas(outputDiv, {
    scale: 2,              // higher quality
    useCORS: true,
    backgroundColor: "#ffffff"
  });

  const imgData = canvas.toDataURL("image/png");

  // Compute scaling so it fits within page margins
  const imgWidth = printableWidth;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;

  let y = margin;
  let x = margin;
  if (imgHeight > pageHeight - margin * 2) {
    // scale down if taller than page
    const scale = (pageHeight - margin * 2) / imgHeight;
    pdf.addImage(imgData, "PNG", x, y, imgWidth * scale, imgHeight * scale);
  } else {
    pdf.addImage(imgData, "PNG", x, y, imgWidth, imgHeight);
  }

  pdf.save("transposed_chords.pdf");
}
</script>

</body>
</html>

